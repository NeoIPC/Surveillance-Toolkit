```{r Validation rule 40: "The length of stay stored in the surgical procedure event does not match the calculated value"}
problems <- problems |>
  bind_rows(
    patients |>
      select(SITE_CODE, DEPARTMENT_NAME, DEPARTMENT_OU, NEOIPC_PATIENT_ID, PATIENT_TEI, key) |>
      rename(patient_key = key) |>
      inner_join(
        enrollments |>
          select(ENROLMENT_ID, ENROLMENT_DATE, key, patient) |>
          rename(enrollment_key = key),
        join_by(patient_key == patient)) |>
      inner_join(
        data$surgeries |>
          select(event, occurredAt, enrollment, NEOIPC_SURGERY_LOS) |>
          rename(EVENT_DATE = occurredAt, EVENT_ID = event),
        join_by(enrollment_key == enrollment)) |>
      mutate(
        PROBLEM_ID = 40L,
        EVENT_TYPE = event_types("SUR"),
        SURGERY_LOS_CALCULATED = as.integer(EVENT_DATE - ENROLMENT_DATE)) |>
      filter(SURGERY_LOS_CALCULATED != NEOIPC_SURGERY_LOS) |>
      select(
        SITE_CODE,
        DEPARTMENT_NAME,
        DEPARTMENT_OU,
        NEOIPC_PATIENT_ID,
        PATIENT_TEI,
        ENROLMENT_ID,
        ENROLMENT_DATE,
        EVENT_ID,
        EVENT_TYPE,
        EVENT_DATE,
        PROBLEM_ID,
        SURGERY_LOS_CALCULATED,
        NEOIPC_SURGERY_LOS
        ))
```
